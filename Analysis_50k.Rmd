---
title: "Results 25K runs"
author: "Jonathan Reeves"
date: sysdate()
output:
  pdf_document: default
  
header-includes:
 \usepackage{float}
 \floatplacement{figure}{H}
---

```{r setup, include=FALSE}
library(knitr)
library(data.table) 
library(dplyr)
library(ggplot2)
library(grid)
library(gridExtra)

knitr::opts_chunk$set(
  echo = FALSE, 
  comment = FALSE,
  warning = FALSE)

run_data <- fread("EXP_1_25k_run_data.csv")
sources <- fread("EXP_1_25K_sources.csv")
trees <- fread("EXP_1_25K_trees.csv")
tools <- fread("EXP_1_25k_tools.csv")
OGs <- subset(tools, Tool_size >= 2000)
```

# 1.0  Spatial distribution of the records

```{r}
run_sum <- tools %>% 
  group_by(run_id, x, y) %>%
  summarise(n_tools = n()) %>%
  group_by(run_id) %>%
  summarise(n_tool_cells = n(),
            per_tool_cells = (n()/(250*250)),
            mean_n = mean(n_tools),
            var_n = var(n_tools))

run_sum$var2mean <- run_sum$var_n/run_sum$mean_n

run_sum <- left_join(run_sum, run_data, by = c("run_id"="run_id"))
```

## 1.1 The influence of sources and trees on the distribution of artifacts

```{r fig.height=4.5, fig.width=6.5, fig.cap= "Boxplots showing the influence of both the number of sources and trees on distribution of the archaeological record. Note that the Y axis is in log scale for visualization purposes. \\label{sourcetreeboxplot}"}

ggplot(run_sum, aes(x = as.factor(num_sources), y = n_tool_cells, fill = as.factor(num_nutree)))+ geom_boxplot()+scale_y_log10()
```
  
  The expedient nature of the modeled nut-cracking behavior tethers the formation of artifact assemblages to the locations of trees and the 8 neighboring grid-cells. To examine the visibility or the size of the archaeological record produced we can use the number of grid cells that contain discard artifacts as a means to investigate the influence of the number of sources and number trees on the formation of this lithic record under the assumptions of the model. Figure \ref{sourcetreeboxplot} shows the influence the quantity of trees and sources on the number of grid cells that accumulate a material record during the model run. This plot shows that both sources and trees have a positive effect on the number of grid-cells that accumulate archaeological assemblages. When the number of trees and sources are low the number of grid-cells or "sites" is low. However, as density of sources and trees increases do the number of sites. Recall that the model is set up so that a source or pounding tool must be within a 2-3 gridcell radius of a tree in order for a nut cracking even to occur. This means that at the beginning of the simulation nut cracking can only occur within places where sources and trees occur within this small radius. Since, the initial placement of sources and trees in any given model run is random, the likelihood of a tree and source occuring with a distance of 3 grid-cells or less depends on the number trees and sources within the model. 
  
  Therefore, when the number of trees and sources in the model is low, the number of places were sources and trees co-occur in this way are few. This results in the creation of localized assemblages within 1-2 grid-cells of trees and sources (Figure \ref{s100t100}). Intuitively, increasing the number of sources in the model run, increases the likelihood of a source and tree occuring close enough in space to trigger a nutcracking even. This in turn increases the number of localized assemblages that are created during the model run (Figure \ref{s100t100}). Increasing the number of trees also increases the number of grid-cells that accumulate archaeological material. As with increasing the number of sources, increasing the number of trees also increases the likelihood that trees and sources will occur close enough together to faciliate a nutcracking event.
 
```{r fig.cap= "Example of a model runs that illustrate the effect of the number of trees on the formation of lithic assemblages. Note that not only does increasing the number of trees increase the number of nut-cracking opportunies but it allows for pounding tools to jump from tree to tree. Key: Sources = Brown, Trees = Green, Sites = Black. \\label{s100t100}", fig.height=4, fig.width=6.5}

nsources <- 100
samp <- subset(run_data, num_sources == nsources & num_nutree == 100 & treessdie == 0)
rand_id <- samp$run_id[sample(1:nrow(samp), 1)]
  
a <- ggplot(tools[tools$run_id == rand_id,], aes(x = x, y = y)) +
    geom_point()+
    geom_point(data = sources[sources$run_id == rand_id], color = "brown", size = .5)+
    geom_point(data = trees[trees$run_id == rand_id], color = "green", size = .5)+
    coord_equal()+
    scale_x_continuous(limits = c(0,250))+
    scale_y_continuous(limits = c(0,250))+
    ggtitle(label = paste("N Sources:", nsources))+
    theme_bw()

nsources <- 500

samp <- subset(run_data, num_sources == nsources & num_nutree == 100 & treessdie == 0)
rand_id <- samp$run_id[sample(1:nrow(samp), 1)]
  
b <- ggplot(tools[tools$run_id == rand_id,], aes(x = x, y = y)) +
    geom_point()+
    geom_point(data = sources[sources$run_id == rand_id], color = "brown", size = .5)+
    geom_point(data = trees[trees$run_id == rand_id], color = "green", size = .5)+
    coord_equal()+
    scale_x_continuous(limits = c(0,250))+
    scale_y_continuous(limits = c(0,250))+
    ggtitle(label = paste("N Sources:", nsources))+
    theme_bw()

grid.arrange(a,b, ncol = 2)
```

   In addition, increasing the density of trees also reduces the distance between on average. Given that the spatial distribution of trees is random, trees will cluster in some parts of the grid-space more closely together than others. This spatial pattern creates an interaction with the tool transport and discard behavior. When a tool is moved from a source and discarded near a tree, it is now also closer to other trees in the grid space. If trees are close enough together, the discard of the tool at one tree facilates nutcracking at another tree that was not within close proximity to a source. In other words, the movement of a tool towards one tree, enables nut-cracking to occur at another regardless of its location to a source (figure\ref{s100t1000}). If trees are clustered close enough together, over time tools will island hop across many trees. This in turn facilates nutcracking and discard of tools and fragments at many more locations. As a result, the discard of tools is more widespread when there are more trees during a given model run. Nut cracking becomes more accessible and frequent because of nut cracking. 
  
```{r fig.cap= "Example of a model run (number of sources 500, number of trees: 1000. When there are larger numbers of trees, there is a greater likelihood that trees occur in clumps which facilitates the movement of stones father from their sources.). \\label{s100t1000}", fig.height=4, fig.width=4}

nsources <- 100
samp <- subset(run_data, num_sources == nsources & num_nutree == 1000 & treessdie == 0)
rand_id <- samp$run_id[sample(1:nrow(samp), 1)]
  
ggplot(tools[tools$run_id == rand_id,], aes(x = x, y = y)) +
    geom_point()+
    geom_point(data = sources[sources$run_id == rand_id], color = "brown")+
    geom_point(data = trees[trees$run_id == rand_id], color = "green")+
    coord_equal()+
    scale_x_continuous(limits = c(0,250))+
    scale_y_continuous(limits = c(0,250))+
    ggtitle(label = paste("N Sources:", nsources))+
    theme_bw()
  
```

### Death and Regrowth of trees

  The death and regrowth of trees also increases distribution of the archaeological record over time. On average, more grid-cells in model runs where trees die and regrow accumulate artifact assemblages that those that do not (Figure: \ref{treedeathmap}). This is because more spots on the landscape become accessible for nut-cracking.

```{r fig.cap= "Example runs illustrating the effect of tree death and regrowth on the distribution of the archaeological assemblages. Notice that there are a greater number of tool using sites in the right panel where trees regrow and die than in the left panel where they do not. \\label{treedeathmap}", fig.height=4, fig.width=6.5}

nsources <- 100
samp <- subset(run_data, num_sources == nsources & num_nutree == 1000 & treessdie == 0)
rand_id <- samp$run_id[sample(1:nrow(samp), 1)]
  
a <- ggplot(tools[tools$run_id == rand_id,], aes(x = x, y = y)) +
    geom_bin2d(bins = 250, show.legend = FALSE)+
    geom_point(data = sources[sources$run_id == rand_id], color = "brown", size = .5)+
    coord_equal()+
    scale_x_continuous(limits = c(0,250))+
    scale_y_continuous(limits = c(0,250))+
    ggtitle(label = paste("Trees Do not"))+
    theme_bw()

samp <- subset(run_data, num_sources == nsources & num_nutree == 1000 & treessdie == 1)
rand_id <- samp$run_id[sample(1:nrow(samp), 1)]

b <- ggplot(tools[tools$run_id == rand_id,], aes(x = x, y = y)) +
    geom_bin2d(bins = 250, show.legend = FALSE)+
    geom_point(data = sources[sources$run_id == rand_id], color = "brown", size = .5)+
    coord_equal()+
    scale_x_continuous(limits = c(0,250))+
    scale_y_continuous(limits = c(0,250))+
    ggtitle(label = paste("Trees Die and Regrow"))+
    theme_bw()
  
grid.arrange(a,b,ncol = 2)
```

  I guess the lession here is that factors like trees dieing restructures the landscape and facilitating the wider spread the of tool using behavior across the landscape.

```{r}

sources$s_id <- paste(sources$run_id, sources$id)
tools$s_id <- paste(tools$run_id, tools$source_id)
source_join <- sources[,c("s_id", "x", "y")]
colnames(source_join) <- c("s_id", "s_x", "s_y")
tools <- left_join(tools, source_join, by = c("s_id" = "s_id"))
tools <- left_join(tools, run_data)
tools$d2source <- sqrt(((tools$x-tools$s_x)^2) + ((tools$y-tools$s_y)^2))

```
### Distance from source

This the behavioral process described above can be observed using archaeological proxies as well. For example, distance a tool travels from the source should be related to the number of trees in the model and whether they die or not.

```{r fig.cap= "The effect of number of trees on distance to source values \\label{d2source}", fig.height= 4, fig.width=6.5}
dist_sum <- tools %>% 
  group_by(num_sources, num_nutree, treessdie) %>%
  summarise(min_d2source = min(d2source),
            mean_d2source = mean(d2source),
            max_d2source = max(d2source))

a <- ggplot(dist_sum, aes(x = as.factor(num_nutree), y = mean_d2source, fill = as.factor(treessdie))) +
  geom_boxplot()+
  theme(legend.position = "top")
b <- ggplot(dist_sum, aes(x = as.factor(num_nutree), y = max_d2source, fill = as.factor(treessdie))) + 
  geom_boxplot() + 
  theme(legend.position = "top")

grid.arrange(a,b, ncol = 2)
```
  
  This plot shows the effect of tree density on distance to source , also see \ref{d2source}). It is clear that tree density has a significant and systematic impact on the distance tools move from their sources. The more trees that are included in the model. In addition, tools from model runs where trees die and regrow (shown in black), are transported farther from the source that when trees remain at a fixed location. However, size of the differences in average tool distances due to the death and regrowth of trees and tree density are small. For example the size of the diffence between model runs with 100 trees versus 1000 trees is a maximum of 3 grid cells. In addition, the effect of trees dying and regrowing is at most 1 grid-cell. Based on the maximum distance to source (Right side of the plot), tree density and tree death and regrowth can have a substantial impact on how far any tool travels. For example as differences between each of the treatments are greater.


```{r fig.cap= "Plots showing the mean and maximum distance to source according to the number of trees and quality of raw materials. Black box plots show runs where trees can die and regrow \\label{d2sourcerm}", fig.height=4, fig.width=6.5}

rm_dist_sum <- tools %>% 
  group_by(num_sources, num_nutree, treessdie, rm_quality) %>%
  summarise(min_d2source = min(d2source),
            mean_d2source = mean(d2source),
            max_d2source = max(d2source))

a <- ggplot(rm_dist_sum[rm_dist_sum$treessdie == 0,], aes(x = as.factor(num_nutree), y = mean_d2source, color = as.factor(rm_quality)), fill = "white") +
  geom_boxplot()+
  geom_boxplot(data = rm_dist_sum[rm_dist_sum$treessdie == 1,], aes(x = as.factor(num_nutree), y = mean_d2source,color = as.factor(rm_quality)), fill = "black") + 
  theme(legend.position = "top")

b <- ggplot(rm_dist_sum[rm_dist_sum$treessdie == 0,], aes(x = as.factor(num_nutree), y = max_d2source, color = as.factor(rm_quality)), fill = "white") +
  geom_boxplot()+
  geom_boxplot(data = rm_dist_sum[rm_dist_sum$treessdie == 1,], aes(x = as.factor(num_nutree), y = max_d2source,color = as.factor(rm_quality)), fill = "black") + 
  theme(legend.position = "top")

grid.arrange(a,b, ncol = 2)
```
  
  The influence of raw material quality doesn't seem to have much of an effect on the distance a tool travels as the source disrances do not seem to be significantly difference between raw material qualities (Figure \ref{d2sourcerm}). It does seem that tools of the highest quality in some in some of the iteractions get farther from their origin source than the lower quality materials. However, this is far less clear than I thought it would be. Maybe this is due to the fact that transport distances are largely dependent on the density of trees and their proximity to sources. If a high quality source does not occur next to a configuration of trees which stones can incrementally moved from tree to tree, then it a high quality material will never travel very far. In contrast if a low quality material is next to a group trees that facilitates this island hopping effect a low quality material could travel farther than a high quality materal. 
  
  It could be that there are is a tree density threshold in which this pattern becomes more clear. Alternatively it may need more time to develope. Compare with runs with more timesteps.
  
```{r fig.cap= "The influence of the number of sources on the mean and max distance to source of tools \\label{d2source_sources}", fig.height=4, fig.width=6.5}

dist_sum <- tools %>% 
  group_by(num_sources, num_nutree, treessdie) %>%
  summarise(min_d2source = min(d2source),
            mean_d2source = mean(d2source),
            max_d2source = max(d2source))

a <- ggplot(dist_sum, aes(x = as.factor(num_sources), y = mean_d2source, fill = as.factor(treessdie))) +
  geom_boxplot()+
  theme(legend.position = "top")
b <- ggplot(dist_sum, aes(x = as.factor(num_sources), y = max_d2source, fill = as.factor(treessdie))) + 
  geom_boxplot() + 
  theme(legend.position = "top")

grid.arrange(a,b, ncol = 2)
```

Not sure what is going on here (Figure \ref{d2source_sources}). I'm also not sure its worth talking about. 
  
# 2.0 The influence the system on archaeological assemblages


### 2.1 Representation of artifact size

  If we are interested in what these time averaged assemblages then the first thing to do would be to test what Tom said about the asssmeblage composition of the artifact assemblages at panda 100.  

```{r}
site_sum <- tools %>%
  group_by(run_id, x, y) %>%
  summarise(min_size = min(Tool_size),
            mean_size = mean(Tool_size),
            max_size = max(Tool_size),
            n_frags = sum(Tool_size < 2000),
            n_tools = sum(Tool_size >= 2000),
            n = n())

site_sum$f2t <- site_sum$n_frags/site_sum$n_tools
site_sum <- left_join(site_sum, run_data, by = c("run_id" = "run_id"))

n_sites_no_tools <- sum(site_sum$n_tools == 0)
per_sites_no_tools <-n_sites_no_tools/nrow(site_sum)
per_sites_1_tool <- sum(site_sum$n_tools == 1)/nrow(site_sum)

```

```{r fig.cap= "Mean size of artifacts according to number of sources (Colors) and trees (x-axis). Y axis is in log scale. Includes both iteractions where trees die and trees do not die \\label{mean_size_source_trees}", fig.height=4, fig.width=6.5}

ggplot(site_sum, aes(x = as.factor(num_nutree), y = mean_size, fill = as.factor(num_sources)))+
  geom_boxplot()+ 
  geom_hline(yintercept = 2000)+
  scale_y_continuous(limits = c(0,20000))+
  scale_y_log10()+
  theme(legend.position = "top")
```
  
  Figure \ref{mean_size_source_trees} shows that the vast majority of artifacts are less than 2000g meaning that they would be classified as fragments. The black bar corresponds to the threhold in which pounding tools are considered exhausted. Note that the average size of an artifact within an individual assemblage for nearly every assemblage falls below this line. In fact, `r round(per_sites_no_tools, 2) *100` percent of sites do not possess hammers. An additional `r round(per_sites_1_tool, 2)*100` percent only possess 1 tool. The number of trees seem to have a small influence in the inter-quartile range on the mean size of artifacts. Inter-quartile ranges seem to get smaller as the number of trees increases. The number of sources seems an equally small but opposite effect.

### The influence of environmental variables on hammer size
  
```{r fig.cap= "The size of hammers according to the number of sources and trees.  \\label{hammersize_source_tree}" , fig.height=4, fig.width=6.5}

OGs <- left_join(OGs, run_data)

ggplot(OGs, aes(x = as.factor(num_nutree), y = Tool_size, fill = as.factor(num_sources)))+
  geom_boxplot()+ 
  geom_hline(yintercept = 2000)+
  theme(legend.position = "top")
  
```

Figure \ref{hammersize_source_tree} demonstrates that neither the number of sources nor trees trees has a significant impact on the size of hammers. This shows that despite the fact that the number of trees reduces that amount of variance in the size of artifact in a given assemblage, it appears as if tools do not get used more or less depending on then number of sources and trees. The distribution of hammer size values also shows that most hammers do not become exhausted over the course of the model run.   

### Tree Death and regrowth
```{r fig.cap= "The size of hammers according to whether or not trees die.  \\label{hammersize_trees_die}", fig.height=4, fig.width=6.5}

ggplot(OGs, aes(x = as.factor(num_nutree), y = Tool_size, fill = as.factor(treessdie)))+
  geom_boxplot()+ 
  geom_hline(yintercept = 2000)+
  theme(legend.position = "top")
  
```

Figure \ref{hammersize_trees_die} demonstrates that the death and regrowth of trees has little effect on hammer size. Further solidifying the fact that trees and sources do not influence how utilized hammers are but rather their transport.

### Effect of distance to source on tool size

```{r fig.height=8, fig.width=6.5, fig.cap= "The influence of the distance to source on the size of the tools, percent nass lost from tools and the number of uses when there are 10 sources and 300 trees \\label{d2source_utilization}"}

OGs <- subset(tools, parent_id == "OG")

OGs$mass_lost <- OGs$original_size - OGs$Tool_size
OGs$per_mass_lost <- OGs$mass_lost/OGs$original_size

a <- ggplot(OGs[OGs$num_sources == 10 & OGs$num_nutree == 300,], aes(x = d2source, y = as.numeric(n_uses), color = as.factor(treessdie)))+ 
  geom_point() 
  

b <- ggplot(OGs[OGs$num_sources == 10 & OGs$num_nutree == 300,], aes(x = d2source, y = Tool_size, color = ts_born))+
  geom_point()

c <- ggplot(OGs[OGs$num_sources == 10 & OGs$num_nutree == 300,], aes(x = d2source, y = per_mass_lost, color = as.factor(rm_quality)))+
  geom_point()
  
grid.arrange(a,b,c, ncol=1)

```


This is futher substantiated by the fact that hammer size is noisly correlated with transport. Hammers that are farther from their sources are more often smaller than those closer. However, it is still possible to get small hammers closer to the source. This result (Figure \ref{d2source_utilization}) is a little counter intuitive. I would have expected there to be a stronger relationship with the number of uses and distance to source. I guess that it is completely influenced by the spatial distribution of trees. If there are enough trees clustered together then the number of uses might be more reflected in distance to source but if there are no trees to island hop between then it will continue to be used at one tree and never get farther from the source. 


###
```{r fig.cap= "The size of hammers according to raw material quality.  \\label{hammersize_rm_quality}", fig.height=4, fig.width=6.5}
  
ggplot(OGs, aes(x = as.factor(num_nutree), y = per_mass_lost, fill = as.factor(rm_quality)))+
  geom_boxplot()+ 
  theme(legend.position = "top")
  
```

Figure \ref{hammersize_rm_quality} demonstrates that raw material quality has a small effect on how utilized stone is. High quality hammers (0) have less mass removed due to fracture than those that are less quality. However, it is not enough to influence the distance that raw materials. We may need more time.

### Fragment to tool ratio   

This is is really interesting because it shows the increased transport of tools influences the composition of the archaeological pattern. 

```{r}

ggplot(site_sum, aes(x = as.factor(num_nutree), y = f2t, fill = as.factor(treessdie))) + geom_boxplot()

```

The ratio of flake to tool is less when trees dies because the death and regrowth process is facilitates the movement of stone. Therefore tools and artifacts get spread out over more space. Whereas when trees are fixed and immortal more time is spent making cracking nuts at a specific set of locations. 

```{r}
ggplot(site_sum, aes(x = as.factor(num_nutree), y = n, fill = as.factor(treessdie))) + geom_boxplot()
```

This is supported by the fact that on average the number artifacts in assemblages from runs where trees die is less than in those where trees do not die. Increased transport spreads artifacts out more. 
